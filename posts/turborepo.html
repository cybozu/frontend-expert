<!DOCTYPE html><html><head><title>workspaceを使ったコマンドを最適化して実行するTurborepoについて | サイボウズ フロントエンドエキスパートチーム</title><meta charSet="utf-8"/><meta name="viewport" content="initial-scale=1.0, width=device-width"/><meta name="description" content="Turborepoの機能について"/><link rel="icon" type="image/png" sizes="32x32" href="/frontend-expert/icons/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/frontend-expert/icons/favicon-16x16.png"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:title" content="workspaceを使ったコマンドを最適化して実行するTurborepoについて | サイボウズ フロントエンドエキスパートチーム"/><meta name="twitter:description" content="Turborepoの機能について"/><meta name="twitter:image " content="https://cybozu.github.io/frontend-expert/ogp/posts/turborepo.jpg"/><meta property="og:type" content="article"/><meta property="og:title" content="workspaceを使ったコマンドを最適化して実行するTurborepoについて | サイボウズ フロントエンドエキスパートチーム"/><meta property="og:site_name" content="サイボウズ フロントエンドエキスパートチーム"/><meta property="og:description" content="Turborepoの機能について"/><meta property="og:image" content="https://cybozu.github.io/frontend-expert/ogp/posts/turborepo.jpg"/><link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/frontend-expert/feeds/atom.xml"/><meta name="next-head-count" content="16"/><link rel="preload" href="/frontend-expert/_next/static/css/76ea63cd4865a048.css" as="style"/><link rel="stylesheet" href="/frontend-expert/_next/static/css/76ea63cd4865a048.css" data-n-g=""/><link rel="preload" href="/frontend-expert/_next/static/css/c09a317f13b9466c.css" as="style"/><link rel="stylesheet" href="/frontend-expert/_next/static/css/c09a317f13b9466c.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/frontend-expert/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/frontend-expert/_next/static/chunks/webpack-729603c643508a46.js" defer=""></script><script src="/frontend-expert/_next/static/chunks/framework-46c1838cec3c6950.js" defer=""></script><script src="/frontend-expert/_next/static/chunks/main-d8805e7f2054e339.js" defer=""></script><script src="/frontend-expert/_next/static/chunks/pages/_app-ab65071b83dd12b3.js" defer=""></script><script src="/frontend-expert/_next/static/chunks/a9a7754c-8a0c949a3a0bc36e.js" defer=""></script><script src="/frontend-expert/_next/static/chunks/247-11af9d0831f37191.js" defer=""></script><script src="/frontend-expert/_next/static/chunks/43-fcd2a5e3bfcce006.js" defer=""></script><script src="/frontend-expert/_next/static/chunks/pages/posts/%5Bslug%5D-0a99538eae08cdc4.js" defer=""></script><script src="/frontend-expert/_next/static/3gofHJDqozw_wf35KygHX/_buildManifest.js" defer=""></script><script src="/frontend-expert/_next/static/3gofHJDqozw_wf35KygHX/_ssgManifest.js" defer=""></script><script src="/frontend-expert/_next/static/3gofHJDqozw_wf35KygHX/_middlewareManifest.js" defer=""></script></head><body><div id="__next"><div class="Layout_layout__3Ma1v"><header class="Header_header__91Nua"><div class="Header_content__JIbnm"><h1><a href="/frontend-expert"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9Ijc4IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZlcnNpb249IjEuMSIvPg=="/></span><img alt="Frontend Expert Team Logo" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="Frontend Expert Team Logo" src="/frontend-expert/logo.png" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span></a></h1><nav class="Header_navigation__2pqVF"><ul><li><a href="/frontend-expert/members">Members</a></li><li><a href="/frontend-expert/posts">Posts</a></li><li><a href="https://cybozu.co.jp/company/job/recruitment/list/front_end_expert.html" target="_blank" rel="noopener noreferrer">Recruiting</a></li></ul></nav></div></header><main class="Layout_main__3t9q9"><div class="Layout_content__2clJn"><h1 class="post_title__3XN0E"><span style="word-break: keep-all; overflow-wrap: break-word;">workspaceを<wbr>使った<wbr>コマンドを<wbr>最適化して<wbr>実行する<wbr>Turborepoに<wbr>ついて</span></h1><div class="post_publishedOn__21gUy">Published on<!-- --> <time dateTime="2022-01-17" itemProp="datePublished">2022-01-17</time></div><div class="post_authors__1qHCs"><div class="post_author__247MG"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:60px;height:60px;background:none;opacity:1;border:0;margin:0;padding:0;position:relative"><img alt="nus3" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="fixed" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="nus3" src="/frontend-expert//member-icons/nus3.jpg" decoding="async" data-nimg="fixed" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span><div class="post_authorInfo__3EEyk"><div class="post_label__20GSj">Author</div><span class="post_authorName__2uB4F"><a href="/frontend-expert/members/nus3">nus3</a></span><ul><li><a href="https://twitter.com/nus3_" aria-label="twitter" class="post_icon__3gvmY" target="_blank" rel="noopener noreferrer"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="twitter" class="svg-inline--fa fa-twitter fa-w-16 " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a></li><li><a href="https://github.com/nus3" aria-label="github" class="post_icon__3gvmY" target="_blank" rel="noopener noreferrer"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github-alt" class="svg-inline--fa fa-github-alt fa-w-15 " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><path fill="currentColor" d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"></path></svg></a></li></ul></div></div></div><div class="PostContent_post__1E6BI"><div><p>今年からフロントエンドエキスパートチームでは活動内容の一つである<strong>探求</strong>の一環として、メンバーが気になった技術に対して、気軽に触ってみる会をしています。次の画像は筆者が Slack で、気軽に触ってみる会の開催を宣言してる時のものです。</p>
<p><img src="/frontend-expert/image/turborepo/slack.png" alt="slackで気軽に触ってみる会を宣言してる" width="718" height="152.15061295971978" ></p>
<p>今回は<a href="https://vercel.com/blog/vercel-acquires-turborepo">去年の 12 月に Vercel に買収されたニュース</a>があった Turborepo を気軽に触ってみました。
個人的には 1 人で調べるときよりも複数人でわいわい調べた方が、その技術や関連する周辺知識の話を色んな人の観点で深掘ってできて、とても有意義な時間でした。</p>
<h2>概要</h2>
<p>Turborepo はモノレポのためのビルドシステムで次のような特徴があります。</p>
<ul>
<li>Yarn, npm, pnpm の workspaces に対応してるリポジトリに対して簡単に導入できる</li>
<li>workspace 内のコマンドの依存関係をシンプルに設定してくれる</li>
<li>Turborepo で実行するコマンドがない package はスルーしてくれる(npm workspace の<code>--if-present</code>に相当)</li>
<li>ローカルキャッシュ、リモートキャッシュを生成・利用できる</li>
</ul>
<h3>サンプルで作ったモノレポ構成</h3>
<p>今回は Yarn v1 の workspace を使ってます。<br>
<a href="https://github.com/nus3/p-turborepo/tree/main/yarn">https://github.com/nus3/p-turborepo/tree/main/yarn</a></p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">├── apps
│   └── nus3-a: Next.js
└── packages:
    ├── nus3-button2: Reactのコンポーネント + ViteのLibrary Modeでビルド
    ├── nus3-config: tsconfig + eslintのconfig
    └── nus3-ui: Reactのコンポーネント(ビルドせずに使う)</code></pre></div>
<p>サンプルで作ったモノレポ内の package たちは次のような依存関係になっています。<br>
(色々試してたので適当な命名になってます。すんません)</p>
<ul>
<li><code>nus3-a</code>は<code>nus3-ui</code>と<code>nus3-button2</code>に依存している</li>
<li><code>nus3-ui</code>は<code>nus3-button2</code>に依存している</li>
</ul>
<p><img src="/frontend-expert/image/turborepo/dependencies.png" alt="サンプルリポジトリの依存関係" width="577" height="314" ></p>
<h3>使い方</h3>
<ol>
<li>使っているパッケージマネージャーで(Yarn, npm, pnpm)で workspace の設定</li>
<li><code>turbo</code>のインストール</li>
<li>package.json に<code>pipeline</code>の設定</li>
</ol>
<h4>1. 使っているパッケージマネージャーで(Yarn, npm, pnpm)で workspace の設定</h4>
<p>workspace の設定については割愛します。各パッケージマネージャーのドキュメントをご覧ください。</p>
<ul>
<li><a href="https://classic.yarnpkg.com/lang/en/docs/workspaces/">Yarn</a></li>
<li><a href="https://docs.npmjs.com/cli/v8/using-npm/workspaces">npm</a></li>
<li><a href="https://pnpm.io/workspaces">pnpm</a></li>
</ul>
<h4>2. <code>turbo</code>のインストール</h4>
<p><code>yarn add turbo -W --dev</code>で Turborepo を追加します。</p>
<h4>3. package.json に<code>pipeline</code>の設定</h4>
<p><code>package.json</code>に<code>turbo.pipeline</code>を追加し、そこで<code>turbo run {command}</code>で実行する command の依存関係やキャッシュの設定をします。この<code>pipeline</code>で定義した command しか<code>turbo run {command}</code>では実行できません。</p>
<p>実際に定義したものが次の json になります。</p>
<div class="remark-highlight"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"turbo"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"pipeline"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"build"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"dependsOn"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"^build"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">"outputs"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"dist/**"</span><span class="token punctuation">,</span> <span class="token string">".next/**"</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"test"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"dependsOn"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"build"</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"lint"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"deploy"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"dependsOn"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"build"</span><span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">,</span> <span class="token string">"lint"</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p><code>dependsOn</code>で依存関係を、<code>outputs</code>でキャッシュするものを指定します。</p>
<p>定義したコマンドを一つずつ見ていきましょう。</p>
<div class="remark-highlight"><pre class="language-json"><code class="language-json"><span class="token property">"dependsOn"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"^build"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</code></pre></div>
<p>dependOn に<code>^</code>を追加したコマンド(<code>^build</code>)を指定することで workspace 内の各 package の指定したコマンド(<code>build</code>)を package 間の依存関係を考慮した順番で実行してくれます。</p>
<p>実際に実行してみると、サンプルで作った各 package の依存関係を考慮した順番(<code>@nus3/example-button2</code> → <code>nus3-ui</code> → <code>nus3-a</code>)でビルドされていることがわかります。<br>
(※今回サンプルで作った構成では<code>nus3-ui</code>はビルドの必要がないですが、依存関係を考慮した順番を表すのにあえて build コマンドを追加しています)</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">$ turbo run build
• Packages in scope: @nus3/example-button2, nus3-a, nus3-config, nus3-ui
• Running build in 4 packages
@nus3/example-button2:build: cache miss, executing a161062b16a0be35
@nus3/example-button2:build: $ vite build &#x26;amp;&#x26;amp; tsc -p ./tsconfig.build.json
...
@nus3/example-button2:build: dist/nus3-example-button2.es.js   3.30 KiB / gzip: 1.39 KiB
nus3-ui:build: cache miss, executing b32d4fb848c8658f
nus3-ui:build: $ echo &#x26;#39;build nus3-ui&#x26;#39;
...
nus3-a:build: cache miss, executing a80d8842624981a8
nus3-a:build: $ next build
...

 Tasks:    3 successful, 3 total
Cached:    0 cached, 3 total
  Time:    5.702s</code></pre></div>
<p>次の<code>outputs</code>はコマンドを実行した際に、<code>dist</code>と<code>.next</code>配下にあるファイル群をキャッシュする設定です。<code>node_modules/.cache/turbo</code>にキャッシュしたファイルが出力されます。</p>
<div class="remark-highlight"><pre class="language-json"><code class="language-json"><span class="token property">"outputs"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"dist/**"</span><span class="token punctuation">,</span> <span class="token string">".next/**"</span><span class="token punctuation">]</span>
</code></pre></div>
<p>先程の build コマンドをもう一度実行すると cache が使われ、前回より早く実行されているのがわかります。</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">$ turbo run build
• Packages in scope: @nus3/example-button2, nus3-a, nus3-config, nus3-ui
• Running build in 4 packages
@nus3/example-button2:build: cache hit, replaying output a161062b16a0be35
...
nus3-ui:build: cache hit, replaying output b32d4fb848c8658f
...
nus3-a:build: cache hit, replaying output a80d8842624981a8
...

 Tasks:    3 successful, 3 total
Cached:    3 cached, 3 total
  Time:    221ms &#x26;gt;&#x26;gt;&#x26;gt; FULL TURBO

✨  Done in 0.57s.
</code></pre></div>
<p>次のように何も指定しない場合、依存関係がないものとして認識され並列に実行されます</p>
<div class="remark-highlight"><pre class="language-json"><code class="language-json"><span class="token property">"lint"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div>
<p>次の deploy コマンドの<code>dependsOn</code>では pipeline で定義した<code>build</code>, <code>test</code>, <code>lint</code>(順不同)を実行し、終了した時点で workspace 内の各 package の<code>deploy</code>コマンドを実行します。</p>
<div class="remark-highlight"><pre class="language-json"><code class="language-json"><span class="token property">"deploy"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">"dependsOn"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"build"</span><span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">,</span> <span class="token string">"lint"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div>
<p>今回定義したものの場合、Turborepo は次のようなことを考慮しながら各々の package のコマンドを実行します。</p>
<ul>
<li><code>build</code>: モノレポ内の各 package の依存関係を考慮しつつ build</li>
<li><code>test</code>: <code>pipeline</code>で定義した<code>build</code>が実行された後に実行</li>
<li><code>lint</code>: 他のコマンドの順番を気にせず、並列で実行</li>
</ul>
<p>deploy コマンドを実行した結果が次になります。</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">$ turbo run deploy
• Packages in scope: @nus3/example-button2, nus3-a, nus3-config, nus3-ui
• Running deploy in 4 packages
nus3-a:lint: $ next lint
@nus3/example-button2:build: $ vite build &#x26;amp;amp;&#x26;amp;amp; tsc -p ./tsconfig.build.json
...
nus3-ui:build: $ echo &#x26;#39;build nus3-ui&#x26;#39;
...
nus3-a:build: $ next build
...
nus3-a:test: $ echo &#x26;#39;test nus3-a&#x26;#39;
...
nus3-a:deploy: $ echo &#x26;#39;deploy nus3-a&#x26;#39;</code></pre></div>
<p>実際に上記を考慮しつつ各 package のコマンドが実行された後に、最後に deploy コマンドが実行されているのがわかると思います。</p>
<p>また、今回はローカルキャッシュの話のみでしたが、Turborepo には<a href="https://turborepo.org/docs/features/remote-caching#vercel">Vercel</a>や<a href="https://turborepo.org/docs/features/remote-caching#custom-remote-caches">独自</a>にキャッシュを配置することで、同じハッシュのキャッシュがあった場合にそのキャッシュを使ってくれる<strong>リモートキャッシュ</strong>といった機能も Beta で用意されています。</p>
<p>今のプロジェクトが Yarn や npm の workspace を使っているのであれば、Turborepo を試しに入れてみてもいいかもしれません。</p>
</div></div><div class="Tags_tags__10UE-"><a class="Tags_tag__2cotv" href="/frontend-expert/tags/Turborepo">Turborepo</a><a class="Tags_tag__2cotv" href="/frontend-expert/tags/Monorepo">Monorepo</a></div><p class="TweetButton_tweetButton__3RBiP"><a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-show-count="false" data-lang="ja">Tweet</a></p><div class="PostContact_postContact__1BrFU">記事に関する報告などは<a href="https://github.com/cybozu/frontend-expert/issues" target="_blank" rel="noopener noreferrer">こちら</a>から</div></div></main><footer class="Footer_footer__2epqf"><div class="Footer_content__3ovcH"><ul><li><a href="https://cybozu.co.jp/">サイボウズ 企業情報</a></li><li><a href="https://www.cybozu.com/jp/">cybozu.com</a></li><li><a href="https://blog.cybozu.io/">サイボウズエンジニアのブログ Cybozu Inside Out</a></li><li><a href="https://tech.cybozu.io/">Cybozu Tech</a></li><li><a href="https://cybozu.co.jp/company/job/recruitment/">採用情報</a></li></ul><small>Copyright © Cybozu, Inc.</small></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"slug":"turborepo","content":"\u003cp\u003e今年からフロントエンドエキスパートチームでは活動内容の一つである\u003cstrong\u003e探求\u003c/strong\u003eの一環として、メンバーが気になった技術に対して、気軽に触ってみる会をしています。次の画像は筆者が Slack で、気軽に触ってみる会の開催を宣言してる時のものです。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/frontend-expert/image/turborepo/slack.png\" alt=\"slackで気軽に触ってみる会を宣言してる\" width=\"718\" height=\"152.15061295971978\" \u003e\u003c/p\u003e\n\u003cp\u003e今回は\u003ca href=\"https://vercel.com/blog/vercel-acquires-turborepo\"\u003e去年の 12 月に Vercel に買収されたニュース\u003c/a\u003eがあった Turborepo を気軽に触ってみました。\n個人的には 1 人で調べるときよりも複数人でわいわい調べた方が、その技術や関連する周辺知識の話を色んな人の観点で深掘ってできて、とても有意義な時間でした。\u003c/p\u003e\n\u003ch2\u003e概要\u003c/h2\u003e\n\u003cp\u003eTurborepo はモノレポのためのビルドシステムで次のような特徴があります。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eYarn, npm, pnpm の workspaces に対応してるリポジトリに対して簡単に導入できる\u003c/li\u003e\n\u003cli\u003eworkspace 内のコマンドの依存関係をシンプルに設定してくれる\u003c/li\u003e\n\u003cli\u003eTurborepo で実行するコマンドがない package はスルーしてくれる(npm workspace の\u003ccode\u003e--if-present\u003c/code\u003eに相当)\u003c/li\u003e\n\u003cli\u003eローカルキャッシュ、リモートキャッシュを生成・利用できる\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3\u003eサンプルで作ったモノレポ構成\u003c/h3\u003e\n\u003cp\u003e今回は Yarn v1 の workspace を使ってます。\u003cbr\u003e\n\u003ca href=\"https://github.com/nus3/p-turborepo/tree/main/yarn\"\u003ehttps://github.com/nus3/p-turborepo/tree/main/yarn\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003e├── apps\n│   └── nus3-a: Next.js\n└── packages:\n    ├── nus3-button2: Reactのコンポーネント + ViteのLibrary Modeでビルド\n    ├── nus3-config: tsconfig + eslintのconfig\n    └── nus3-ui: Reactのコンポーネント(ビルドせずに使う)\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eサンプルで作ったモノレポ内の package たちは次のような依存関係になっています。\u003cbr\u003e\n(色々試してたので適当な命名になってます。すんません)\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003enus3-a\u003c/code\u003eは\u003ccode\u003enus3-ui\u003c/code\u003eと\u003ccode\u003enus3-button2\u003c/code\u003eに依存している\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003enus3-ui\u003c/code\u003eは\u003ccode\u003enus3-button2\u003c/code\u003eに依存している\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/frontend-expert/image/turborepo/dependencies.png\" alt=\"サンプルリポジトリの依存関係\" width=\"577\" height=\"314\" \u003e\u003c/p\u003e\n\u003ch3\u003e使い方\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e使っているパッケージマネージャーで(Yarn, npm, pnpm)で workspace の設定\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eturbo\u003c/code\u003eのインストール\u003c/li\u003e\n\u003cli\u003epackage.json に\u003ccode\u003epipeline\u003c/code\u003eの設定\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch4\u003e1. 使っているパッケージマネージャーで(Yarn, npm, pnpm)で workspace の設定\u003c/h4\u003e\n\u003cp\u003eworkspace の設定については割愛します。各パッケージマネージャーのドキュメントをご覧ください。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://classic.yarnpkg.com/lang/en/docs/workspaces/\"\u003eYarn\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://docs.npmjs.com/cli/v8/using-npm/workspaces\"\u003enpm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://pnpm.io/workspaces\"\u003epnpm\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch4\u003e2. \u003ccode\u003eturbo\u003c/code\u003eのインストール\u003c/h4\u003e\n\u003cp\u003e\u003ccode\u003eyarn add turbo -W --dev\u003c/code\u003eで Turborepo を追加します。\u003c/p\u003e\n\u003ch4\u003e3. package.json に\u003ccode\u003epipeline\u003c/code\u003eの設定\u003c/h4\u003e\n\u003cp\u003e\u003ccode\u003epackage.json\u003c/code\u003eに\u003ccode\u003eturbo.pipeline\u003c/code\u003eを追加し、そこで\u003ccode\u003eturbo run {command}\u003c/code\u003eで実行する command の依存関係やキャッシュの設定をします。この\u003ccode\u003epipeline\u003c/code\u003eで定義した command しか\u003ccode\u003eturbo run {command}\u003c/code\u003eでは実行できません。\u003c/p\u003e\n\u003cp\u003e実際に定義したものが次の json になります。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-json\"\u003e\u003ccode class=\"language-json\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"turbo\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"pipeline\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003e\"build\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token property\"\u003e\"dependsOn\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"^build\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token property\"\u003e\"outputs\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"dist/**\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\".next/**\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003e\"test\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token property\"\u003e\"dependsOn\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"build\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003e\"lint\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003e\"deploy\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token property\"\u003e\"dependsOn\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"build\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"test\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"lint\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003ccode\u003edependsOn\u003c/code\u003eで依存関係を、\u003ccode\u003eoutputs\u003c/code\u003eでキャッシュするものを指定します。\u003c/p\u003e\n\u003cp\u003e定義したコマンドを一つずつ見ていきましょう。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-json\"\u003e\u003ccode class=\"language-json\"\u003e\u003cspan class=\"token property\"\u003e\"dependsOn\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"^build\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003edependOn に\u003ccode\u003e^\u003c/code\u003eを追加したコマンド(\u003ccode\u003e^build\u003c/code\u003e)を指定することで workspace 内の各 package の指定したコマンド(\u003ccode\u003ebuild\u003c/code\u003e)を package 間の依存関係を考慮した順番で実行してくれます。\u003c/p\u003e\n\u003cp\u003e実際に実行してみると、サンプルで作った各 package の依存関係を考慮した順番(\u003ccode\u003e@nus3/example-button2\u003c/code\u003e → \u003ccode\u003enus3-ui\u003c/code\u003e → \u003ccode\u003enus3-a\u003c/code\u003e)でビルドされていることがわかります。\u003cbr\u003e\n(※今回サンプルで作った構成では\u003ccode\u003enus3-ui\u003c/code\u003eはビルドの必要がないですが、依存関係を考慮した順番を表すのにあえて build コマンドを追加しています)\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003e$ turbo run build\n• Packages in scope: @nus3/example-button2, nus3-a, nus3-config, nus3-ui\n• Running build in 4 packages\n@nus3/example-button2:build: cache miss, executing a161062b16a0be35\n@nus3/example-button2:build: $ vite build \u0026#x26;amp;\u0026#x26;amp; tsc -p ./tsconfig.build.json\n...\n@nus3/example-button2:build: dist/nus3-example-button2.es.js   3.30 KiB / gzip: 1.39 KiB\nnus3-ui:build: cache miss, executing b32d4fb848c8658f\nnus3-ui:build: $ echo \u0026#x26;#39;build nus3-ui\u0026#x26;#39;\n...\nnus3-a:build: cache miss, executing a80d8842624981a8\nnus3-a:build: $ next build\n...\n\n Tasks:    3 successful, 3 total\nCached:    0 cached, 3 total\n  Time:    5.702s\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e次の\u003ccode\u003eoutputs\u003c/code\u003eはコマンドを実行した際に、\u003ccode\u003edist\u003c/code\u003eと\u003ccode\u003e.next\u003c/code\u003e配下にあるファイル群をキャッシュする設定です。\u003ccode\u003enode_modules/.cache/turbo\u003c/code\u003eにキャッシュしたファイルが出力されます。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-json\"\u003e\u003ccode class=\"language-json\"\u003e\u003cspan class=\"token property\"\u003e\"outputs\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"dist/**\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\".next/**\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e先程の build コマンドをもう一度実行すると cache が使われ、前回より早く実行されているのがわかります。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003e$ turbo run build\n• Packages in scope: @nus3/example-button2, nus3-a, nus3-config, nus3-ui\n• Running build in 4 packages\n@nus3/example-button2:build: cache hit, replaying output a161062b16a0be35\n...\nnus3-ui:build: cache hit, replaying output b32d4fb848c8658f\n...\nnus3-a:build: cache hit, replaying output a80d8842624981a8\n...\n\n Tasks:    3 successful, 3 total\nCached:    3 cached, 3 total\n  Time:    221ms \u0026#x26;gt;\u0026#x26;gt;\u0026#x26;gt; FULL TURBO\n\n✨  Done in 0.57s.\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e次のように何も指定しない場合、依存関係がないものとして認識され並列に実行されます\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-json\"\u003e\u003ccode class=\"language-json\"\u003e\u003cspan class=\"token property\"\u003e\"lint\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e次の deploy コマンドの\u003ccode\u003edependsOn\u003c/code\u003eでは pipeline で定義した\u003ccode\u003ebuild\u003c/code\u003e, \u003ccode\u003etest\u003c/code\u003e, \u003ccode\u003elint\u003c/code\u003e(順不同)を実行し、終了した時点で workspace 内の各 package の\u003ccode\u003edeploy\u003c/code\u003eコマンドを実行します。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-json\"\u003e\u003ccode class=\"language-json\"\u003e\u003cspan class=\"token property\"\u003e\"deploy\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"dependsOn\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"build\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"test\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"lint\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e今回定義したものの場合、Turborepo は次のようなことを考慮しながら各々の package のコマンドを実行します。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003ebuild\u003c/code\u003e: モノレポ内の各 package の依存関係を考慮しつつ build\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003etest\u003c/code\u003e: \u003ccode\u003epipeline\u003c/code\u003eで定義した\u003ccode\u003ebuild\u003c/code\u003eが実行された後に実行\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003elint\u003c/code\u003e: 他のコマンドの順番を気にせず、並列で実行\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003edeploy コマンドを実行した結果が次になります。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003e$ turbo run deploy\n• Packages in scope: @nus3/example-button2, nus3-a, nus3-config, nus3-ui\n• Running deploy in 4 packages\nnus3-a:lint: $ next lint\n@nus3/example-button2:build: $ vite build \u0026#x26;amp;amp;\u0026#x26;amp;amp; tsc -p ./tsconfig.build.json\n...\nnus3-ui:build: $ echo \u0026#x26;#39;build nus3-ui\u0026#x26;#39;\n...\nnus3-a:build: $ next build\n...\nnus3-a:test: $ echo \u0026#x26;#39;test nus3-a\u0026#x26;#39;\n...\nnus3-a:deploy: $ echo \u0026#x26;#39;deploy nus3-a\u0026#x26;#39;\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e実際に上記を考慮しつつ各 package のコマンドが実行された後に、最後に deploy コマンドが実行されているのがわかると思います。\u003c/p\u003e\n\u003cp\u003eまた、今回はローカルキャッシュの話のみでしたが、Turborepo には\u003ca href=\"https://turborepo.org/docs/features/remote-caching#vercel\"\u003eVercel\u003c/a\u003eや\u003ca href=\"https://turborepo.org/docs/features/remote-caching#custom-remote-caches\"\u003e独自\u003c/a\u003eにキャッシュを配置することで、同じハッシュのキャッシュがあった場合にそのキャッシュを使ってくれる\u003cstrong\u003eリモートキャッシュ\u003c/strong\u003eといった機能も Beta で用意されています。\u003c/p\u003e\n\u003cp\u003e今のプロジェクトが Yarn や npm の workspace を使っているのであれば、Turborepo を試しに入れてみてもいいかもしれません。\u003c/p\u003e\n","metaData":{"title":"workspaceを使ったコマンドを最適化して実行するTurborepoについて","author":"nus3","createdAt":"2022-01-17","summary":"Turborepoの機能について","tags":["Turborepo","Monorepo"],"updatedAt":"2022-01-17"}}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"turborepo"},"buildId":"3gofHJDqozw_wf35KygHX","assetPrefix":"/frontend-expert","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>