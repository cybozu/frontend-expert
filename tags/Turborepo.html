<!DOCTYPE html><html lang="ja"><head><title>Turborepo | サイボウズ フロントエンドエキスパートチーム</title><meta charSet="utf-8"/><meta name="viewport" content="initial-scale=1.0, width=device-width"/><meta name="description" content="サイボウズ フロントエンドエキスパートチームのウェブサイトです"/><link rel="icon" type="image/png" sizes="32x32" href="/frontend-expert/icons/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/frontend-expert/icons/favicon-16x16.png"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:title" content="Turborepo | サイボウズ フロントエンドエキスパートチーム"/><meta name="twitter:description" content="サイボウズ フロントエンドエキスパートチームのウェブサイトです"/><meta name="twitter:image " content="https://cybozu.github.io/frontend-expert/ogp/ogp.jpg"/><meta property="og:type" content="article"/><meta property="og:title" content="Turborepo | サイボウズ フロントエンドエキスパートチーム"/><meta property="og:site_name" content="サイボウズ フロントエンドエキスパートチーム"/><meta property="og:description" content="サイボウズ フロントエンドエキスパートチームのウェブサイトです"/><meta property="og:image" content="https://cybozu.github.io/frontend-expert/ogp/ogp.jpg"/><link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/frontend-expert/feeds/atom.xml"/><meta name="next-head-count" content="16"/><link rel="preload" href="/frontend-expert/_next/static/css/d15332f741e09aa2.css" as="style"/><link rel="stylesheet" href="/frontend-expert/_next/static/css/d15332f741e09aa2.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/frontend-expert/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/frontend-expert/_next/static/chunks/webpack-b0f44a7ac00bf3cb.js" defer=""></script><script src="/frontend-expert/_next/static/chunks/framework-742985a85518e1e1.js" defer=""></script><script src="/frontend-expert/_next/static/chunks/main-242b1a0e32bf923c.js" defer=""></script><script src="/frontend-expert/_next/static/chunks/pages/_app-ff35bec35d2bc313.js" defer=""></script><script src="/frontend-expert/_next/static/chunks/247-c193c27d2f31cb66.js" defer=""></script><script src="/frontend-expert/_next/static/chunks/836-39a19b1bc48d36a2.js" defer=""></script><script src="/frontend-expert/_next/static/chunks/pages/tags/%5Btag%5D-6dba5b90ce91c053.js" defer=""></script><script src="/frontend-expert/_next/static/VlVMQJJAJOo5wwejn7ISe/_buildManifest.js" defer=""></script><script src="/frontend-expert/_next/static/VlVMQJJAJOo5wwejn7ISe/_ssgManifest.js" defer=""></script><script src="/frontend-expert/_next/static/VlVMQJJAJOo5wwejn7ISe/_middlewareManifest.js" defer=""></script></head><body><div id="__next"><style data-emotion="css ruypru">.css-ruypru{width:100%;}.css-ruypru .main{max-width:100%;background-color:white;}.css-ruypru .main .content{margin:0 auto;max-width:var(--content-width);box-sizing:border-box;padding:1rem 1rem 1.5rem;min-height:400px;}</style><div class="css-ruypru"><style data-emotion="css 14l5li6">.css-14l5li6{padding:1.2rem 0 1rem;background-color:var(--primary-color);}.css-14l5li6 .content{max-width:var(--content-width);margin:0 auto;padding:0 1rem;box-sizing:border-box;}.css-14l5li6 h1{font-size:1.6rem;}.css-14l5li6 .navigation ul{margin:0;list-style:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}.css-14l5li6 .navigation ul li{padding:0.2rem 0;font-size:1rem;}.css-14l5li6 .navigation ul li:not(:last-child)::after{content:"/";margin:0 0.4rem;color:var(--light-font-color);}.css-14l5li6 a{color:var(--light-font-color);}</style><header class="css-14l5li6"><div class="content"><h1><a href="/frontend-expert"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%27200%27%20height=%2778%27/%3e"/></span><img alt="Frontend Expert Team Logo" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="Frontend Expert Team Logo" src="/frontend-expert/logo.png" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span></a></h1><nav class="navigation"><ul><li><a href="/frontend-expert/members">Members</a></li><li><a href="/frontend-expert/posts">Posts</a></li><li><a href="https://cybozu.co.jp/company/job/recruitment/list/front_end_expert.html" target="_blank" rel="noopener noreferrer">Recruiting</a></li></ul></nav></div></header><main class="main"><div class="content"><h2>Turborepo</h2><style data-emotion="css 3x8wln">.css-3x8wln .item{font-size:1.1rem;padding:12px 4px 8px;}.css-3x8wln .item+.item{margin-top:8px;border-top:1px solid #ebebeb;}.css-3x8wln .title{font-size:1.2em;}.css-3x8wln .tags{margin-top:12px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;grid-gap:8px;}.css-3x8wln .tag{font-size:0.5em;border:1px solid;padding:2px 4px;border-radius:2px;color:currentColor;}.css-3x8wln .date{font-size:0.8em;}.css-3x8wln .author{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;grid-gap:8px;padding-top:8px;}.css-3x8wln .author img{border-radius:4px;}</style><div class="css-3x8wln"><div class="item"><a href="/frontend-expert/posts/considerations-for-monorepo"><div class="title">フロントエンドのモノレポ構成はスケーリングの夢を見るか</div><div class="author"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:30px;height:30px;background:none;opacity:1;border:0;margin:0;padding:0;position:relative"><img alt="nus3" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="fixed" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="nus3" src="/frontend-expert//member-icons/nus3.jpg" decoding="async" data-nimg="fixed" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span><span class="date">2022-01-31</span></div><div class="tags"><span class="tag">Monorepo</span><span class="tag">Turborepo</span></div></a></div><div class="item"><a href="/frontend-expert/posts/turborepo"><div class="title">workspaceを使ったコマンドを最適化して実行するTurborepoについて</div><div class="author"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:30px;height:30px;background:none;opacity:1;border:0;margin:0;padding:0;position:relative"><img alt="nus3" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="fixed" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="nus3" src="/frontend-expert//member-icons/nus3.jpg" decoding="async" data-nimg="fixed" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span><span class="date">2022-01-17</span></div><div class="tags"><span class="tag">Turborepo</span><span class="tag">Monorepo</span></div></a></div></div></div></main><style data-emotion="css 1n88omd">.css-1n88omd{padding:2.4rem 0;background-color:var(--primary-color);color:white;}.css-1n88omd .content{max-width:var(--content-width);padding:0 1.2rem;box-sizing:border-box;margin:0 auto;}.css-1n88omd a{color:white;}.css-1n88omd ul{list-style:none;margin-bottom:2.5rem;}.css-1n88omd ul li{font-size:1.2rem;margin-bottom:0.5rem;}.css-1n88omd small{font-size:1rem;}</style><footer class="css-1n88omd"><div class="content"><ul><li><a href="https://cybozu.co.jp/">サイボウズ 企業情報</a></li><li><a href="https://www.cybozu.com/jp/">cybozu.com</a></li><li><a href="https://blog.cybozu.io/">サイボウズエンジニアのブログ Cybozu Inside Out</a></li><li><a href="https://tech.cybozu.io/">Cybozu Tech</a></li><li><a href="https://cybozu.co.jp/company/job/recruitment/">採用情報</a></li></ul><small>Copyright © Cybozu, Inc.</small></div></footer></div>;<!-- --></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"posts":[{"slug":"considerations-for-monorepo","content":"\u003cp\u003eそれっぽいタイトルを付けましたが特に意味はないです。\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://cybozu.github.io/frontend-expert/posts/turborepo\"\u003eworkspace を使ったコマンドを最適化して実行する Turborepo について\u003c/a\u003eのお話で Turborepo を軽く触ってみた際に\u003ccode\u003enpx create-turbo@latest\u003c/code\u003eで作られる構成がとてもわかりやすく、プロダクトの初期段階からモノレポを採用するのは選択肢の 1 つとしていいのでは、と思い続編を書きました。\u003c/p\u003e\n\u003cp\u003e前回と同じくサンプルのリポジトリはこちらになります。\u003cbr\u003e\n\u003ca href=\"https://github.com/nus3/p-turborepo/tree/main/yarn\"\u003ehttps://github.com/nus3/p-turborepo/tree/main/yarn\u003c/a\u003e\u003c/p\u003e\n\u003ch2\u003e概要\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eモノレポを採用することで、同一リポジトリ内で自作した汎用的なライブラリやコンポーネントを複数のアプリケーションで使いまわせる\u003c/li\u003e\n\u003cli\u003eモノレポの規模が大きくなってきた場合には、モノレポ内のパッケージを npm に公開することでアプリケーションとパッケージを非同期に開発できる\u003c/li\u003e\n\u003cli\u003eYarn や npm の workspace はイイゾ！\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eモノレポとは\u003c/h2\u003e\n\u003cp\u003eモノレポとは本記事では npm や Yarn の workspaces 機能を使い、1 つのリポジトリ内で複数の npm パッケージを管理している構成のこととします。\u003c/p\u003e\n\u003ch3\u003enpm や Yarn の workspaces\u003c/h3\u003e\n\u003cp\u003enpm や Yarn の workspaces は 1 つのリポジトリ内で複数の npm パッケージを管理するための機能です。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://classic.yarnpkg.com/lang/en/docs/workspaces/\"\u003eYarn(v1)\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://yarnpkg.com/features/workspaces\"\u003eYarn(v2 以降)\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://docs.npmjs.com/cli/v8/using-npm/workspaces\"\u003enpm\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eworkspaces を使うにはリポジトリのルート直下にある\u003ccode\u003epackage.json\u003c/code\u003eに\u003ccode\u003eworkspaces\u003c/code\u003eを追加します。\u003c/p\u003e\n\u003cp\u003e例えば\u003ccode\u003eapps\u003c/code\u003e配下にアプリケーションの npm パッケージを、\u003ccode\u003epackages\u003c/code\u003e配下に汎用的なコンポーネント、ライブラリなどの npm パッケージを入れる場合、次のようになります。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-json\"\u003e\u003ccode class=\"language-json\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"workspaces\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"apps/*\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"packages/*\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003ccode\u003eapps\u003c/code\u003e 配下にある\u003ccode\u003enus3-a\u003c/code\u003eというアプリケーションから \u003ccode\u003epackages\u003c/code\u003e 配下にある\u003ccode\u003enus3-ui\u003c/code\u003eという名前の npm パッケージを使う場合、それぞれ次のような\u003ccode\u003epackage.json\u003c/code\u003eになります。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eapps/nus3-a\u003c/code\u003e\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-json\"\u003e\u003ccode class=\"language-json\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"name\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"nus3-a\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"version\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"0.0.0\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"dependencies\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"nus3-ui\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"*\"\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// Yarnのv2以降であれば`workspace:`構文が使えるようになる\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// REF: (nus3) https://yarnpkg.com/features/workspaces#workspace-ranges-workspace\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// \"nus3-ui\": \"workspace:*\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003ccode\u003epackages/nus3-ui\u003c/code\u003e\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-json\"\u003e\u003ccode class=\"language-json\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"name\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"nus3-ui\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"version\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"0.0.0\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eworkspaces 内にある npm パッケージの名前が npm に公開されているパッケージ名と同じ場合は、 workspace 内の npm パッケージが優先してインストールされます。後々 workspaces 内の npm パッケージを公開する可能性がある場合、パッケージ名は npm で公開されているパッケージ名と被らない名前にした方が良いかもしれません。\u003c/p\u003e\n\u003cp\u003eworkspace 内の npm パッケージを依存関係に追加すると node_modules にシンボリックリンクが作成されます。次の画像のように node_modules 配下に\u003ccode\u003enus3-ui\u003c/code\u003eと\u003ccode\u003enus3-a\u003c/code\u003eのシンボリックリンクが追加されていることが確認できます。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/frontend-expert/image/considerations-for-monorepo/symlink.png\" alt=\"node_modulesに作成されたシンボリックリンク\" width=\"340\" height=\"101\" \u003e\u003c/p\u003e\n\u003cp\u003eシンボリックリンクにより依存する npm パッケージのコードを直接参照するので、npm に公開しバージョン管理するまでは、version は\u003ccode\u003e0.0.0\u003c/code\u003e、かつ、使う側は\u003ccode\u003e\"nus3-ui\": \"*\"\u003c/code\u003eのようにワイルドカードを指定するとバージョンのことを意識せずに管理できます。\u003c/p\u003e\n\u003ch3\u003ecreate-turbo で作られるモノレポ構成\u003c/h3\u003e\n\u003cp\u003ecreate-turbo(\u003ccode\u003enpx create-turbo@latest\u003c/code\u003e) では作られるモノレポ構成に次のようなものが含まれます。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003enpm に公開せずに config をモノレポ内の別パッケージに分けて、複数のパッケージから使用する\u003c/li\u003e\n\u003cli\u003eReact を使った汎用的なコンポーネント(tsx)を別パッケージに分けて アプリケーション(Next.js)で使用する\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eそれぞれ見ていきましょう。\u003c/p\u003e\n\u003ch4\u003enpm に公開せずに config をモノレポ内の別パッケージに分けて、複数のパッケージから使用する\u003c/h4\u003e\n\u003cp\u003eESLint や Stylelint の config は npm に公開することで、異なるプロジェクトで共通の設定を使えます。サイボウズでは\u003ca href=\"https://github.com/cybozu/eslint-config\"\u003e@cybozu/eslint-config\u003c/a\u003eや\u003ca href=\"https://github.com/cybozu/stylelint-config\"\u003e@cybozu/stylelint-config\u003c/a\u003eとして npm に公開しています。\u003c/p\u003e\n\u003cp\u003eモノレポ内であれば ESLint や Stylelint の設定を npm に公開・管理せずに共有することもできます。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003epackages/nus3-config\u003c/code\u003e\u003cbr\u003e\nで共通の ESLint や TSConfig を定義して、\u003ccode\u003epackage.json\u003c/code\u003e の\u003ccode\u003efiles\u003c/code\u003e に指定します。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-json\"\u003e\u003ccode class=\"language-json\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"name\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"nus3-config\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"version\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"0.0.0\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"files\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n    \u003cspan class=\"token string\"\u003e\"eslint-preset.js\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string\"\u003e\"tsconfig.base.json\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string\"\u003e\"tsconfig.nextjs.json\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string\"\u003e\"tsconfig.react-library.json\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003ccode\u003eapps/nus3-a\u003c/code\u003e\nで\u003ccode\u003enus3-config\u003c/code\u003eを追加し、\u003ccode\u003enus3-config\u003c/code\u003eから TSConfig や ESLint のルールを適用します。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-json\"\u003e\u003ccode class=\"language-json\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"name\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"nus3-a\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"version\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"0.0.0\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"devDependencies\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"eslint\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"8.6.0\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"nus3-config\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"*\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003ccode\u003eapps/nus3-a/tsconfig.json\u003c/code\u003e\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-json\"\u003e\u003ccode class=\"language-json\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"extends\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"nus3-config/tsconfig.nextjs.json\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003ccode\u003eapps/nus3-a/.eslintrc\u003c/code\u003e\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003emodule\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eexports\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003erequire\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"nus3-config/eslint-preset\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch4\u003eReact を使った汎用的なコンポーネント(tsx)を別パッケージに分けて アプリケーション(Next.js)で使用する\u003c/h4\u003e\n\u003cp\u003ecreate-turbo では汎用的な React コンポーネントを tsx ファイルのまま \u003ccode\u003epackages\u003c/code\u003e 配下の npm パッケージで管理し、Next.js の\u003ca href=\"https://github.com/martpie/next-transpile-modules\"\u003eplugin\u003c/a\u003eを使って アプリケーション 側でトランスパイルしています。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003epackages/nus3-ui\u003c/code\u003e\u003cbr\u003e\nで React(tsx)のコンポーネントを実装します。実装した tsx ファイルのパスをそのまま\u003ccode\u003emain\u003c/code\u003eと\u003ccode\u003etypes\u003c/code\u003eに追加します。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-json\"\u003e\u003ccode class=\"language-json\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"name\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"nus3-ui\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"version\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"0.0.0\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"main\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"./index.tsx\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"types\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"./index.tsx\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"devDependencies\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"@types/react\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"17.0.37\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"@types/react-dom\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"17.0.11\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"typescript\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"4.5.4\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003ccode\u003epackages/nus3-ui/index.tsx\u003c/code\u003e\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-tsx\"\u003e\u003ccode class=\"language-tsx\"\u003e\u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"token constant\"\u003eVFC\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"react\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"token maybe-class-name\"\u003eButton\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token function-variable function\"\u003eVFC\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003ebutton\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token plain-text\"\u003eボタン\u003c/span\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;/\u003c/span\u003ebutton\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003ccode\u003eapps/nus3-a\u003c/code\u003e\u003cbr\u003e\n\u003ccode\u003enus3-ui\u003c/code\u003eの tsx ファイルを\u003ccode\u003enus3-a\u003c/code\u003eで\u003ccode\u003enext-transpile-modules\u003c/code\u003eを使ってトランスパイルします。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-json\"\u003e\u003ccode class=\"language-json\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"name\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"nus3-a\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"version\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"0.0.0\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"devDependencies\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"next-transpile-modules\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"9.0.0\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003ccode\u003eapps/nus3-a/next.config.js\u003c/code\u003e\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e withTM \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003erequire\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"next-transpile-modules\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"nus3-ui\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\nmodule\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eexports\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003ewithTM\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2\u003eフロントエンドのモノレポ戦略\u003c/h2\u003e\n\u003cp\u003e筆者のこれまでの経験では、創業して間もない会社やプロダクトの初期フェーズで、複数のアプリケーションの開発が並列して始まることが多くありました。そういった状況では、モノレポを採用しておくと複数のアプリケーションで共通したコンポーネントやライブラリを少ないコストで使用できます。\u003c/p\u003e\n\u003cp\u003eまた、モノレポ内で共通して使っているパッケージに変更を加える際に、その影響範囲が把握できないくらいモノレポの規模が大きくなった場合には、パッケージを npm に公開してバージョン管理することで、バージョンの変更タイミングを各々のアプリケーションに任せることができ、アプリケーションとパッケージの開発を非同期に行うことができます。\u003c/p\u003e\n\u003cp\u003eこのように、初期段階では汎用的な npm パッケージをアセットとして複数のアプリケーションに提供することで開発スピードを上げられ、また、規模が大きくなってきた場合はパッケージを npm に公開するといった方針をとることもできます。\u003c/p\u003e\n\u003cp\u003eもちろん、1 つのリポジトリですべてのパッケージを管理することやコードベースが大きく複雑になることなどデメリットもあり、モノレポを採用することが適切ではない場合もあります。メリット・デメリットを踏まえつつ、フロントエンドの技術選定の中にモノレポの採用を選択肢の 1 つとして入れてもいいかもしれません。\u003c/p\u003e\n","metaData":{"title":"フロントエンドのモノレポ構成はスケーリングの夢を見るか","author":"nus3","editor":["nakajmg"],"createdAt":"2022-01-31","summary":"Turborepoのstarterでできるモノレポ構成からスケーリングするフロントエンドの構成について考える","tags":["Monorepo","Turborepo"],"updatedAt":"2022-01-31"}},{"slug":"turborepo","content":"\u003cp\u003e今年からフロントエンドエキスパートチームでは活動内容の一つである\u003cstrong\u003e探求\u003c/strong\u003eの一環として、メンバーが気になった技術に対して、気軽に触ってみる会をしています。次の画像は筆者が Slack で、気軽に触ってみる会の開催を宣言してる時のものです。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/frontend-expert/image/turborepo/slack.png\" alt=\"slackで気軽に触ってみる会を宣言してる\" width=\"718\" height=\"152.15061295971978\" \u003e\u003c/p\u003e\n\u003cp\u003e今回は\u003ca href=\"https://vercel.com/blog/vercel-acquires-turborepo\"\u003e去年の 12 月に Vercel に買収されたニュース\u003c/a\u003eがあった Turborepo を気軽に触ってみました。\n個人的には 1 人で調べるときよりも複数人でわいわい調べた方が、その技術や関連する周辺知識の話を色んな人の観点で深掘ってできて、とても有意義な時間でした。\u003c/p\u003e\n\u003ch2\u003e概要\u003c/h2\u003e\n\u003cp\u003eTurborepo はモノレポのためのビルドシステムで次のような特徴があります。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eYarn, npm, pnpm の workspaces に対応してるリポジトリに対して簡単に導入できる\u003c/li\u003e\n\u003cli\u003eworkspace 内のコマンドの依存関係をシンプルに設定してくれる\u003c/li\u003e\n\u003cli\u003eTurborepo で実行するコマンドがない package はスルーしてくれる(npm workspace の\u003ccode\u003e--if-present\u003c/code\u003eに相当)\u003c/li\u003e\n\u003cli\u003eローカルキャッシュ、リモートキャッシュを生成・利用できる\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3\u003eサンプルで作ったモノレポ構成\u003c/h3\u003e\n\u003cp\u003e今回は Yarn v1 の workspace を使ってます。\u003cbr\u003e\n\u003ca href=\"https://github.com/nus3/p-turborepo/tree/main/yarn\"\u003ehttps://github.com/nus3/p-turborepo/tree/main/yarn\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003e├── apps\n│   └── nus3-a: Next.js\n└── packages:\n    ├── nus3-button2: Reactのコンポーネント + ViteのLibrary Modeでビルド\n    ├── nus3-config: tsconfig + eslintのconfig\n    └── nus3-ui: Reactのコンポーネント(ビルドせずに使う)\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eサンプルで作ったモノレポ内の package たちは次のような依存関係になっています。\u003cbr\u003e\n(色々試してたので適当な命名になってます。すんません)\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003enus3-a\u003c/code\u003eは\u003ccode\u003enus3-ui\u003c/code\u003eと\u003ccode\u003enus3-button2\u003c/code\u003eに依存している\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003enus3-ui\u003c/code\u003eは\u003ccode\u003enus3-button2\u003c/code\u003eに依存している\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/frontend-expert/image/turborepo/dependencies.png\" alt=\"サンプルリポジトリの依存関係\" width=\"577\" height=\"314\" \u003e\u003c/p\u003e\n\u003ch3\u003e使い方\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e使っているパッケージマネージャーで(Yarn, npm, pnpm)で workspace の設定\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eturbo\u003c/code\u003eのインストール\u003c/li\u003e\n\u003cli\u003epackage.json に\u003ccode\u003epipeline\u003c/code\u003eの設定\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch4\u003e1. 使っているパッケージマネージャーで(Yarn, npm, pnpm)で workspace の設定\u003c/h4\u003e\n\u003cp\u003eworkspace の設定については割愛します。各パッケージマネージャーのドキュメントをご覧ください。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://classic.yarnpkg.com/lang/en/docs/workspaces/\"\u003eYarn\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://docs.npmjs.com/cli/v8/using-npm/workspaces\"\u003enpm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://pnpm.io/workspaces\"\u003epnpm\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch4\u003e2. \u003ccode\u003eturbo\u003c/code\u003eのインストール\u003c/h4\u003e\n\u003cp\u003e\u003ccode\u003eyarn add turbo -W --dev\u003c/code\u003eで Turborepo を追加します。\u003c/p\u003e\n\u003ch4\u003e3. package.json に\u003ccode\u003epipeline\u003c/code\u003eの設定\u003c/h4\u003e\n\u003cp\u003e\u003ccode\u003epackage.json\u003c/code\u003eに\u003ccode\u003eturbo.pipeline\u003c/code\u003eを追加し、そこで\u003ccode\u003eturbo run {command}\u003c/code\u003eで実行する command の依存関係やキャッシュの設定をします。この\u003ccode\u003epipeline\u003c/code\u003eで定義した command しか\u003ccode\u003eturbo run {command}\u003c/code\u003eでは実行できません。\u003c/p\u003e\n\u003cp\u003e実際に定義したものが次の json になります。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-json\"\u003e\u003ccode class=\"language-json\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"turbo\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"pipeline\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003e\"build\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token property\"\u003e\"dependsOn\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"^build\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token property\"\u003e\"outputs\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"dist/**\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\".next/**\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003e\"test\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token property\"\u003e\"dependsOn\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"build\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003e\"lint\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"token property\"\u003e\"deploy\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token property\"\u003e\"dependsOn\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"build\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"test\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"lint\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003ccode\u003edependsOn\u003c/code\u003eで依存関係を、\u003ccode\u003eoutputs\u003c/code\u003eでキャッシュするものを指定します。\u003c/p\u003e\n\u003cp\u003e定義したコマンドを一つずつ見ていきましょう。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-json\"\u003e\u003ccode class=\"language-json\"\u003e\u003cspan class=\"token property\"\u003e\"dependsOn\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"^build\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003edependOn に\u003ccode\u003e^\u003c/code\u003eを追加したコマンド(\u003ccode\u003e^build\u003c/code\u003e)を指定することで workspace 内の各 package の指定したコマンド(\u003ccode\u003ebuild\u003c/code\u003e)を package 間の依存関係を考慮した順番で実行してくれます。\u003c/p\u003e\n\u003cp\u003e実際に実行してみると、サンプルで作った各 package の依存関係を考慮した順番(\u003ccode\u003e@nus3/example-button2\u003c/code\u003e → \u003ccode\u003enus3-ui\u003c/code\u003e → \u003ccode\u003enus3-a\u003c/code\u003e)でビルドされていることがわかります。\u003cbr\u003e\n(※今回サンプルで作った構成では\u003ccode\u003enus3-ui\u003c/code\u003eはビルドの必要がないですが、依存関係を考慮した順番を表すのにあえて build コマンドを追加しています)\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003e$ turbo run build\n• Packages in scope: @nus3/example-button2, nus3-a, nus3-config, nus3-ui\n• Running build in 4 packages\n@nus3/example-button2:build: cache miss, executing a161062b16a0be35\n@nus3/example-button2:build: $ vite build \u0026#x26;amp;\u0026#x26;amp; tsc -p ./tsconfig.build.json\n...\n@nus3/example-button2:build: dist/nus3-example-button2.es.js   3.30 KiB / gzip: 1.39 KiB\nnus3-ui:build: cache miss, executing b32d4fb848c8658f\nnus3-ui:build: $ echo \u0026#x26;#39;build nus3-ui\u0026#x26;#39;\n...\nnus3-a:build: cache miss, executing a80d8842624981a8\nnus3-a:build: $ next build\n...\n\n Tasks:    3 successful, 3 total\nCached:    0 cached, 3 total\n  Time:    5.702s\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e次の\u003ccode\u003eoutputs\u003c/code\u003eはコマンドを実行した際に、\u003ccode\u003edist\u003c/code\u003eと\u003ccode\u003e.next\u003c/code\u003e配下にあるファイル群をキャッシュする設定です。\u003ccode\u003enode_modules/.cache/turbo\u003c/code\u003eにキャッシュしたファイルが出力されます。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-json\"\u003e\u003ccode class=\"language-json\"\u003e\u003cspan class=\"token property\"\u003e\"outputs\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"dist/**\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\".next/**\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e先程の build コマンドをもう一度実行すると cache が使われ、前回より早く実行されているのがわかります。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003e$ turbo run build\n• Packages in scope: @nus3/example-button2, nus3-a, nus3-config, nus3-ui\n• Running build in 4 packages\n@nus3/example-button2:build: cache hit, replaying output a161062b16a0be35\n...\nnus3-ui:build: cache hit, replaying output b32d4fb848c8658f\n...\nnus3-a:build: cache hit, replaying output a80d8842624981a8\n...\n\n Tasks:    3 successful, 3 total\nCached:    3 cached, 3 total\n  Time:    221ms \u0026#x26;gt;\u0026#x26;gt;\u0026#x26;gt; FULL TURBO\n\n✨  Done in 0.57s.\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e次のように何も指定しない場合、依存関係がないものとして認識され並列に実行されます\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-json\"\u003e\u003ccode class=\"language-json\"\u003e\u003cspan class=\"token property\"\u003e\"lint\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e次の deploy コマンドの\u003ccode\u003edependsOn\u003c/code\u003eでは pipeline で定義した\u003ccode\u003ebuild\u003c/code\u003e, \u003ccode\u003etest\u003c/code\u003e, \u003ccode\u003elint\u003c/code\u003e(順不同)を実行し、終了した時点で workspace 内の各 package の\u003ccode\u003edeploy\u003c/code\u003eコマンドを実行します。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-json\"\u003e\u003ccode class=\"language-json\"\u003e\u003cspan class=\"token property\"\u003e\"deploy\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"dependsOn\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"build\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"test\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"lint\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e今回定義したものの場合、Turborepo は次のようなことを考慮しながら各々の package のコマンドを実行します。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003ebuild\u003c/code\u003e: モノレポ内の各 package の依存関係を考慮しつつ build\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003etest\u003c/code\u003e: \u003ccode\u003epipeline\u003c/code\u003eで定義した\u003ccode\u003ebuild\u003c/code\u003eが実行された後に実行\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003elint\u003c/code\u003e: 他のコマンドの順番を気にせず、並列で実行\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003edeploy コマンドを実行した結果が次になります。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003e$ turbo run deploy\n• Packages in scope: @nus3/example-button2, nus3-a, nus3-config, nus3-ui\n• Running deploy in 4 packages\nnus3-a:lint: $ next lint\n@nus3/example-button2:build: $ vite build \u0026#x26;amp;amp;\u0026#x26;amp;amp; tsc -p ./tsconfig.build.json\n...\nnus3-ui:build: $ echo \u0026#x26;#39;build nus3-ui\u0026#x26;#39;\n...\nnus3-a:build: $ next build\n...\nnus3-a:test: $ echo \u0026#x26;#39;test nus3-a\u0026#x26;#39;\n...\nnus3-a:deploy: $ echo \u0026#x26;#39;deploy nus3-a\u0026#x26;#39;\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e実際に上記を考慮しつつ各 package のコマンドが実行された後に、最後に deploy コマンドが実行されているのがわかると思います。\u003c/p\u003e\n\u003cp\u003eまた、今回はローカルキャッシュの話のみでしたが、Turborepo には\u003ca href=\"https://turborepo.org/docs/features/remote-caching#vercel\"\u003eVercel\u003c/a\u003eや\u003ca href=\"https://turborepo.org/docs/features/remote-caching#custom-remote-caches\"\u003e独自\u003c/a\u003eにキャッシュを配置することで、同じハッシュのキャッシュがあった場合にそのキャッシュを使ってくれる\u003cstrong\u003eリモートキャッシュ\u003c/strong\u003eといった機能も Beta で用意されています。\u003c/p\u003e\n\u003cp\u003e今のプロジェクトが Yarn や npm の workspace を使っているのであれば、Turborepo を試しに入れてみてもいいかもしれません。\u003c/p\u003e\n","metaData":{"title":"workspaceを使ったコマンドを最適化して実行するTurborepoについて","author":"nus3","createdAt":"2022-01-17","summary":"Turborepoの機能について","tags":["Turborepo","Monorepo"],"updatedAt":"2022-01-17"}}],"tag":"Turborepo"},"__N_SSG":true},"page":"/tags/[tag]","query":{"tag":"Turborepo"},"buildId":"VlVMQJJAJOo5wwejn7ISe","assetPrefix":"/frontend-expert","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>