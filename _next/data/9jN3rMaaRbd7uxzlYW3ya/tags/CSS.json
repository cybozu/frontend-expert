{"pageProps":{"posts":[{"slug":"css-cascade-layers","content":"<p><a href=\"https://developer.chrome.com/blog/new-in-chrome-99/\">Chrome99</a>に新機能として CSS Cascade Layers が実装され、Firefox、Edge、Safari といった主要ブラウザで CSS Cascade Layers が使えるようになりました。</p>\n<h2>CSS Cascade Layers とは</h2>\n<p>CSS の仕様において、要素にどのスタイルを適用するかはざっくりと次のような優先順位で決定されていました。(カスケード順を省いて簡略的に記述しています)</p>\n<ol>\n<li><code>!important</code></li>\n<li>インラインスタイル</li>\n<li>セレクターの詳細度</li>\n<li>同じ詳細度であれば最後に宣言されたもの</li>\n</ol>\n<p>ここに CSS Cascade Layers が導入されると次のように変わります。</p>\n<ol>\n<li><code>!important</code></li>\n<li>インラインスタイル</li>\n<li><strong>Cascade Layers</strong></li>\n<li>セレクターの詳細度</li>\n<li>同じ詳細度であれば最後に宣言されたもの</li>\n</ol>\n<h2>従来の CSS が抱える複雑な詳細度の管理</h2>\n<p>どのスタイルを適用するか判断するのにセレクターの詳細度を用いる場合は、詳細度がより高いものが適用されます。</p>\n<p>セレクターの詳細度は、高い順に次のような順番になります。</p>\n<ol>\n<li>ID セレクター: <code>#example</code></li>\n<li>クラスセレクター: <code>.example</code>, 属性セレクター: <code>[type=\"radio\"]</code>, 疑似クラス: <code>:hover</code></li>\n<li>要素型セレクター: <code>h1</code>, 擬似要素: <code>::before</code></li>\n</ol>\n<p>また、単純にセレクターの種類だけでなく、セレクターの数も詳細度に影響します。</p>\n<p>参考: <a href=\"https://specifishity.com/\">https://specifishity.com/</a></p>\n<p>CSS の記述量が増えていくにつれ、この詳細度をうまく管理できず意図しないスタイルが適用されることがままあります。意図しないスタイルが適用されないために、セレクターの命名規則を厳格にする<a href=\"http://getbem.com/naming/\">BEM</a>などの設計手法を取り入れて対応することもあります。</p>\n<p>しかし、命名規則をベースとした設計手法では、サードパーティの CSS ライブラリを使用する場合や、コントロールが難しいくらい多い記述量の CSS になってしまった場合、全体の詳細度を把握して管理することはなかなか大変です。</p>\n<h2>Cascade Layers によってどう変わるか</h2>\n<p>Cascade Layers を使うと、セレクターの詳細度よりも優先してスタイルが適用されるレイヤーを定義できるようになります。</p>\n<p>実際にコードで見てみましょう。</p>\n<h3>通常の詳細度を使ったスタイルの適用</h3>\n<p>Cascade Layers を使わない場合、同じ詳細度のセレクターは属性値での記述順に関わらず、スタイルシート内で最後に宣言されたスタイルが適用されます。</p>\n<p>次の場合、<code>.base</code> と <code>.nus3</code> は同一の詳細度です。また、1 つ目の <code>.base</code> は最後に記述されている <code>.base</code> によって上書きされます。このボタンには<code>style</code>内で一番最後に記述されている <code>.base</code> のスタイルが適用され、背景色が <code>royalblue</code> になります。</p>\n<div class=\"remark-highlight\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;</span>style</span><span class=\"token punctuation\">></span></span><span class=\"token style\"><span class=\"token language-css\">\n  <span class=\"token selector\"><span class=\"token class\">.base</span></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">background-color</span><span class=\"token punctuation\">:</span> <span class=\"token color\">crimson</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token selector\"><span class=\"token class\">.nus3</span></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">background-color</span><span class=\"token punctuation\">:</span> <span class=\"token color\">white</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token selector\"><span class=\"token class\">.base</span></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">background-color</span><span class=\"token punctuation\">:</span> <span class=\"token color\">royalblue</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">/* このスタイルが適用される */</span>\n  <span class=\"token punctuation\">}</span>\n</span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;/</span>style</span><span class=\"token punctuation\">></span></span>\n\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;</span>button</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>base nus3<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>royalblueになる<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;/</span>button</span><span class=\"token punctuation\">></span></span>\n</code></pre></div>\n<p>また、セレクターの詳細度は種類によって異なり、要素セレクター &#x3C; クラスセレクター &#x3C; ID セレクター の順に高くなります。</p>\n<p>次の場合、ID セレクター(<code>#btn</code>)のほうがクラスセレクター(<code>.nus3</code>) や要素セレクター(<code>button</code>)よりも詳細度が高いので、<code>#btn</code> のスタイルが適用されます。</p>\n<div class=\"remark-highlight\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;</span>style</span><span class=\"token punctuation\">></span></span><span class=\"token style\"><span class=\"token language-css\">\n  <span class=\"token selector\">button</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">background-color</span><span class=\"token punctuation\">:</span> <span class=\"token color\">coral</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token selector\"><span class=\"token id\">#btn</span></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">background-color</span><span class=\"token punctuation\">:</span> <span class=\"token color\">crimson</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">/* このスタイルが適用される */</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token selector\"><span class=\"token class\">.nus3</span></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">background-color</span><span class=\"token punctuation\">:</span> <span class=\"token color\">black</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n</span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;/</span>style</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;</span>button</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>btn<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>nus3<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>crimsonになる<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;/</span>button</span><span class=\"token punctuation\">></span></span>\n</code></pre></div>\n<h3>Cascade Layers を使ったスタイルの適用</h3>\n<p>Cascade Layers では、まず<code>@layer</code>構文を使ってレイヤーを定義します。</p>\n<div class=\"remark-highlight\"><pre class=\"language-css\"><code class=\"language-css\">`<span class=\"token atrule\"><span class=\"token rule\">@layer</span> base<span class=\"token punctuation\">,</span> page<span class=\"token punctuation\">,</span> utilities<span class=\"token punctuation\">;</span></span>`\n</code></pre></div>\n<p>このとき、base、page、utilities の 3 つのレイヤーを定義するとともに、レイヤーの優先順位を定義しています。</p>\n<p>この場合、各レイヤーのスタイルは後ろに定義したものほど優先度が高く、次のような優先度でスタイルが適用されます。</p>\n<ol>\n<li>utilities</li>\n<li>page</li>\n<li>base</li>\n</ol>\n<p>ここではレイヤーの定義と優先度を同時に定義していますが、この記述を省略した場合、あとに定義したレイヤーの優先度が高くなります。</p>\n<p>レイヤーの動作についてサンプルコードで詳しく見てみましょう。</p>\n<p>次のコードは、前述したコードをベースに <code>@layer</code> を追加したものです。</p>\n<div class=\"remark-highlight\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;</span>style</span><span class=\"token punctuation\">></span></span><span class=\"token style\"><span class=\"token language-css\">\n  <span class=\"token atrule\"><span class=\"token rule\">@layer</span> base<span class=\"token punctuation\">,</span> page<span class=\"token punctuation\">,</span> utilities<span class=\"token punctuation\">;</span></span>\n\n  <span class=\"token atrule\"><span class=\"token rule\">@layer</span> utilities</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token selector\"><span class=\"token class\">.shiny</span></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">background-color</span><span class=\"token punctuation\">:</span> <span class=\"token color\">gold</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token atrule\"><span class=\"token rule\">@layer</span> page</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token selector\"><span class=\"token id\">#btn</span></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">background-color</span><span class=\"token punctuation\">:</span> <span class=\"token color\">crimson</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token atrule\"><span class=\"token rule\">@layer</span> base</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token selector\"><span class=\"token class\">.base</span></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">background-color</span><span class=\"token punctuation\">:</span> <span class=\"token color\">crimson</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token selector\"><span class=\"token class\">.nus3</span></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">background-color</span><span class=\"token punctuation\">:</span> <span class=\"token color\">white</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n</span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;/</span>style</span><span class=\"token punctuation\">></span></span>\n\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;</span>button</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>shiny base nus3<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>goldになる<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;/</span>button</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;</span>button</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>btn<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>shiny<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>goldになる<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;/</span>button</span><span class=\"token punctuation\">></span></span>\n</code></pre></div>\n<p>１つ目のボタンはレイヤーがない場合には最後に宣言されている <code>.nus3</code> の <code>white</code> が適用されていましたが、優先度の高い utilities レイヤーに定義した <code>.shiny</code> の <code>gold</code> が適用されます。</p>\n<p>２つ目のボタンはレイヤーがない場合には ID セレクターの <code>#btn</code> のスタイルが適用されていましたが、この場合も utilities レイヤーに定義した <code>.shiny</code> のほうが優先度が高いため、 <code>gold</code> が適用されます。</p>\n<p>次のサンプルページを開いて、DevTools で対象の要素をみると Cascade Layers が適用されているのがわかります。</p>\n<p><a href=\"https://c1r38o.csb.app/\">サンプルページ</a></p>\n<p><img src=\"/frontend-expert/image/css-cascade-layers/devtools.png\" alt=\"DevToolsで確認すると実際にCascade Layersが適用されている\" width=\"337\" height=\"400\" ></p>\n<p>レイヤーの適用順が utilities > page > base になってるのがわかります。</p>\n<p>このように、Cascade Layers を使うことで、詳細度ではなくレイヤーでスタイルをコントロールできるようになります。</p>\n<h3>Cascade Layers 内で<code>!important</code>を使った際のスタイルの優先順位</h3>\n<p><code>!important</code>を使っていない場合、Cascade Layers で定義したレイヤー外のスタイルが優先して適用されます。</p>\n<p>これはカスケード順が、レイヤー内 &#x3C; レイヤー外 の順に高くなっているからです。</p>\n<p>次のコードでは、レイヤー外のスタイルが適用され、ボタンの背景色が<code>white</code>になります。</p>\n<div class=\"remark-highlight\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;</span>style</span><span class=\"token punctuation\">></span></span><span class=\"token style\"><span class=\"token language-css\">\n  <span class=\"token atrule\"><span class=\"token rule\">@layer</span> base</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token selector\"><span class=\"token class\">.nus3</span></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">background-color</span><span class=\"token punctuation\">:</span> <span class=\"token color\">gold</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token selector\"><span class=\"token class\">.nus3</span></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">background-color</span><span class=\"token punctuation\">:</span> <span class=\"token color\">white</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">/* このスタイルが適用される */</span>\n  <span class=\"token punctuation\">}</span>\n</span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;/</span>style</span><span class=\"token punctuation\">></span></span>\n\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;</span>button</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>nus3<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>whiteになる<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;/</span>button</span><span class=\"token punctuation\">></span></span>\n</code></pre></div>\n<p>しかし、<code>!important</code>を使ったスタイルの場合、このカスケード順が変わるので注意が必要です。</p>\n<div class=\"remark-highlight\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;</span>style</span><span class=\"token punctuation\">></span></span><span class=\"token style\"><span class=\"token language-css\">\n  <span class=\"token atrule\"><span class=\"token rule\">@layer</span> base</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token selector\"><span class=\"token class\">.nus3</span></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">background-color</span><span class=\"token punctuation\">:</span> <span class=\"token color\">gold</span> <span class=\"token important\">!important</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">/* このスタイルが適用される */</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token selector\"><span class=\"token class\">.nus3</span></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">background-color</span><span class=\"token punctuation\">:</span> <span class=\"token color\">white</span> <span class=\"token important\">!important</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n</span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;/</span>style</span><span class=\"token punctuation\">></span></span>\n\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;</span>button</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>nus3<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>goldになる<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;/</span>button</span><span class=\"token punctuation\">></span></span>\n</code></pre></div>\n<h2>CSS フレームワークにも Cascade Layers は使える</h2>\n<p>Bootstrap や Materialize CSS、Bulma といった CSS フレームワークにも Cascade Layers を使ってレイヤーを定義できます。</p>\n<p>CSS フレームワークの一つである<a href=\"https://bulma.io/\">Bulma</a>を使って試してみましょう。</p>\n<p>本来、次のようなクラスをボタンに付与すると、Bulma で元から定義されている<code>.button.is-primary</code>が、後に追加した<code>.button-nus3</code>より詳細度が高くなり、<code>.button-nus3</code>のスタイルは適用されません。</p>\n<div class=\"remark-highlight\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;</span>button</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>button is-primary button-nus3<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>ボタン<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;/</span>button</span><span class=\"token punctuation\">></span></span>\n</code></pre></div>\n<div class=\"remark-highlight\"><pre class=\"language-css\"><code class=\"language-css\"><span class=\"token atrule\"><span class=\"token rule\">@import</span> <span class=\"token string\">\"https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css\"</span><span class=\"token punctuation\">;</span></span>\n<span class=\"token atrule\"><span class=\"token rule\">@import</span> <span class=\"token string\">\"styles/page.css\"</span><span class=\"token punctuation\">;</span></span>\n\n<span class=\"token comment\">/* styles/page.cssで定義されているスタイル */</span>\n<span class=\"token selector\"><span class=\"token class\">.button-nus3</span></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">background-color</span><span class=\"token punctuation\">:</span> <span class=\"token color\">gold</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>しかし次のように Cascade Layers を使い、<a href=\"https://bulma.io/\">Bulma</a>の CSS を<code>base</code>のレイヤーにしつつ、画面特有のスタイルを<code>styles/page.css</code>に定義することで、詳細度の影響を気にすることなく Bulma のスタイルを上書きすることができます。</p>\n<div class=\"remark-highlight\"><pre class=\"language-css\"><code class=\"language-css\"><span class=\"token atrule\"><span class=\"token rule\">@layer</span> base<span class=\"token punctuation\">,</span> page<span class=\"token punctuation\">;</span></span>\n\n<span class=\"token atrule\"><span class=\"token rule\">@import</span> <span class=\"token string\">\"https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css\"</span> <span class=\"token function\">layer</span><span class=\"token punctuation\">(</span>base<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>\n<span class=\"token atrule\"><span class=\"token rule\">@import</span> <span class=\"token string\">\"styles/page.css\"</span> <span class=\"token function\">layer</span><span class=\"token punctuation\">(</span>page<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>\n</code></pre></div>\n<p>対象ブラウザのサポート状況は考慮する必要がありますが、CSS の記述量が増えることが想定されるプロジェクトには、Cascade Layers をベースにした設計を検討してみてはいかがでしょうか。</p>\n<h2>参考リンクなど</h2>\n<ul>\n<li><a href=\"https://www.w3.org/TR/css-cascade-5/\">https://www.w3.org/TR/css-cascade-5/</a></li>\n<li><a href=\"https://developer.mozilla.org/en-US/docs/Web/CSS/@layer\">https://developer.mozilla.org/en-US/docs/Web/CSS/@layer</a></li>\n<li><a href=\"https://developer.chrome.com/blog/cascade-layers/\">https://developer.chrome.com/blog/cascade-layers/</a></li>\n<li><a href=\"https://github.com/nus3/p-css-cascade-layers\">サンプル実装したリポジトリ</a></li>\n</ul>\n","metaData":{"title":"主要ブラウザで使える！CSS Cascade Layers で新しいCSS設計の手法を考える","author":"nus3","editor":["nakajmg"],"createdAt":"2022-03-22","summary":"CSS Cascade Layersを使ったスタイルの管理方法について紹介します","tags":["CSS"],"updatedAt":"2022-03-22"}}],"tag":"CSS"},"__N_SSG":true}